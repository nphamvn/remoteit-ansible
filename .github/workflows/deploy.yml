on:
    workflow_dispatch:
env:
    HOST: localhost:30001
    USERNAME: pi
jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install remote.it CLI
              shell: bash
              run: |
                  set -euo pipefail

                  # Pick the right binary for runner arch
                  ARCH="$(uname -m)"
                  case "$ARCH" in
                  x86_64|amd64) BIN_URL="https://downloads.remote.it/cli/latest/remoteit.x86_64-linux" ;;
                  aarch64|arm64) BIN_URL="https://downloads.remote.it/cli/latest/remoteit.aarch64-linux" ;;
                  *)
                      echo "Unsupported arch: $ARCH"
                      exit 1
                      ;;
                  esac

                  sudo curl -fsSL "$BIN_URL" -o /usr/local/bin/remoteit
                  sudo chmod +x /usr/local/bin/remoteit

                  remoteit version
                  sudo remoteit install

            - name: Write remote.it credentials
              run: |
                  mkdir -p ~/.remoteit
                  cat > ~/.remoteit/credentials <<'EOF'
                  [DEFAULT]
                  R3_ACCESS_KEY_ID=${{ secrets.R3_ACCESS_KEY_ID }}
                  R3_SECRET_ACCESS_KEY=${{ secrets.R3_SECRET_ACCESS_KEY }}
                  EOF
                  chmod 600 ~/.remoteit/credentials
                  remoteit account credentials
            - name: Connect remoteit
              run: |
                  chmod +x ./deploy/connect_remoteit.sh
                  ./deploy/connect_remoteit.sh "raspberrypi" "SSH" "${{ secrets.R3_ACCESS_KEY_ID }}" "${{ secrets.R3_SECRET_ACCESS_KEY }}"

            - name: Deploy Application
              working-directory: ./deploy
              run: |
                  chmod +x ./deploy.sh
                  ./deploy.sh
