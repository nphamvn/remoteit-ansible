on:
  workflow_dispatch:
    inputs:
      plant:
        type: choice
        description: "Plant ID to deploy"
        required: true
        options:
          - "raspberrypi"
          - "ec2"

      version:
        description: "Application version to deploy"
        required: true

      deploy_gui:
        type: boolean
        description: "Whether to deploy the GUI"
        required: false
        default: true
jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get configs #TODO: should get from API or AWS Secret Manager
        id: get_configs
        run: |
          NETWORK=$(jq -r --arg PLANT "$PLANT" '.plants[] | select(.id == $PLANT) | .network' ./deploy/configs.json)
          echo "network=$NETWORK"
          echo "network=$NETWORK" >> "$GITHUB_OUTPUT"
        env:
          PLANT: ${{ github.event.inputs.plant }}
      # Network Connection Steps::Start
      - name: Install remote.it CLI and sign in
        if: steps.get_configs.outputs.network == 'remoteit'
        shell: bash
        run: |
          set -euo pipefail

          # Pick the right binary for runner arch
          ARCH="$(uname -m)"
          case "$ARCH" in
          x86_64|amd64) BIN_URL="https://downloads.remote.it/cli/latest/remoteit.x86_64-linux" ;;
          aarch64|arm64) BIN_URL="https://downloads.remote.it/cli/latest/remoteit.aarch64-linux" ;;
          *)
              echo "Unsupported arch: $ARCH"
              exit 1
              ;;
          esac

          sudo curl -fsSL "$BIN_URL" -o /usr/local/bin/remoteit
          sudo chmod +x /usr/local/bin/remoteit

          remoteit version
          sudo remoteit install
          # TODO: signin with secret key/ api token instead of password
          sudo remoteit account signin --user '${{ vars.REMOTEIT_USER }}' --pass '${{ secrets.REMOTEIT_PASSWORD }}'
          sleep 5

      - name: Connect remote.it ssh service
        if: steps.get_configs.outputs.network == 'remoteit'
        shell: bash
        run: |
          chmod +x ./deploy/connect_remoteit.sh
          sudo -E ./deploy/connect_remoteit.sh
        env:
          PLANT: ${{ github.event.inputs.plant }}
          R3_ACCESS_KEY_ID: ${{ secrets.R3_ACCESS_KEY_ID }}
          R3_SECRET_ACCESS_KEY: ${{ secrets.R3_SECRET_ACCESS_KEY }}
          LOCAL_PORT: 30001

      - name: Configure AWS credentials
        if: steps.get_configs.outputs.network == 'vpn'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::075313985331:role/github-actions-secrets-role
          aws-region: ap-northeast-1

      - name: Get OpenVPN config
        if: steps.get_configs.outputs.network == 'vpn'
        run: |
          aws secretsmanager get-secret-value \
            --secret-id openvpn-client \
            --query SecretString \
            --output text > client.ovpn
          chmod 600 client.ovpn

      - name: Install OpenVPN client and connect
        if: steps.get_configs.outputs.network == 'vpn'
        run: |
          sudo apt-get update && sudo apt-get install -y openvpn && \
          sudo openvpn --config client.ovpn --daemon && \
          sleep 10

      # Network Connection Steps::End
      - name: Install Ansible
        run: |
          sudo apt-get update && sudo apt-get install -y ansible

      - name: Deploy Application
        working-directory: ./deploy
        run: |
          ansible-playbook playbook.yml
        env:
          # Connection specific variables
          ANSIBLE_HOST: ${{ steps.get_configs.outputs.network == 'remoteit' && 'localhost' || '10.8.0.4' }}
          ANSIBLE_PORT: ${{ steps.get_configs.outputs.network == 'remoteit' && '30001' || '22' }}
          ANSIBLE_USER: ${{ vars.SERVER_USERNAME }}
          ANSIBLE_SSH_PASS: ${{ secrets.SERVER_PASSWORD }}
          ANSIBLE_HOST_KEY_CHECKING: "False"
          # Deployment specific variables
          PLANT: ${{ github.event.inputs.plant }}
          VERSION: ${{ github.event.inputs.version }}
          DEPLOY_GUI: ${{ github.event.inputs.deploy_gui }}

      - name: Cleanup
        if: always() && steps.get_configs.outputs.network == 'vpn'
        run: |
          sudo pkill openvpn || true
          rm -f client.ovpn
  complete_deploy:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "Deployment succeeded with version ${{ github.event.inputs.version }} to plant ${{ github.event.inputs.plant }}"
            # Add notification logic here (e.g., send to Slack, email, etc.)
          else
            echo "Deployment failed"
            # Add failure notification logic here
          fi
