on:
  workflow_dispatch:
  push:
    branches:
      - main
env:
    HOST: localhost:30001
    USERNAME: pi
jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install remote.it CLI
              shell: bash
              run: |
                  set -euo pipefail

                  # Pick the right binary for runner arch
                  ARCH="$(uname -m)"
                  case "$ARCH" in
                  x86_64|amd64) BIN_URL="https://downloads.remote.it/cli/latest/remoteit.x86_64-linux" ;;
                  aarch64|arm64) BIN_URL="https://downloads.remote.it/cli/latest/remoteit.aarch64-linux" ;;
                  *)
                      echo "Unsupported arch: $ARCH"
                      exit 1
                      ;;
                  esac

                  sudo curl -fsSL "$BIN_URL" -o /usr/local/bin/remoteit
                  sudo chmod +x /usr/local/bin/remoteit

                  remoteit version
                  sudo remoteit install

            - name: Write remote.it credentials
              run: |
                  mkdir -p ~/.remoteit
                  cat > ~/.remoteit/credentials <<'EOF'
                  [DEFAULT]
                  R3_ACCESS_KEY_ID=CJX27WASA6U5SVBOJY6W
                  R3_SECRET_ACCESS_KEY=6DvJ1up2yuCMQ6P2JMAmndRsMs0kRwyEOMhqNEPZ
                  EOF
                  chmod 600 ~/.remoteit/credentials
                  sudo remoteit account signin --user 'pvnam95@hotmail.com' --pass '${{ secrets.REMOTEIT_PASSWORD }}'
            - name: Get SSH Service Id
              shell: bash
              run: |
                  chmod +x ./deploy/connect_remoteit.sh
                  ./deploy/connect_remoteit.sh "CJX27WASA6U5SVBOJY6W" "6DvJ1up2yuCMQ6P2JMAmndRsMs0kRwyEOMhqNEPZ" "raspberrypi" "SSH"
            - name: Connect
              run: |
                sudo remoteit connection add --id 90:00:00:00:00:2A:D4:1E --port 30001 --p2p true && sleep 5 && \
                remoteit status && sleep 5 && \
                sudo remoteit connection connect --id 90:00:00:00:00:2A:D4:1E && sleep 10 && \
                remoteit status
            - name: Install Ansible
              run: |
                  sudo apt-get update
                  sudo apt-get install -y ansible
            
            - name: Deploy Application
              working-directory: ./deploy
              run: |
                  ansible-playbook playbook.yml
