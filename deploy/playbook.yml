- name: Deploy application
  hosts: localhost
  gather_facts: false

  vars:
    ansible_host: "{{ lookup('env','ANSIBLE_HOST') }}"
    ansible_port: "{{ lookup('env','ANSIBLE_PORT') | int }}"
    ansible_user: "{{ lookup('env','ANSIBLE_USER') }}"
    ansible_ssh_pass: "{{ lookup('env','ANSIBLE_SSH_PASS') }}"
    ansible_connection: ssh
    ansible_python_interpreter: /usr/bin/python3

    plant: "{{ lookup('env','PLANT') }}"
    version: "{{ lookup('env','VERSION') }}"
    deploy_gui: "{{ lookup('env','DEPLOY_GUI') | default('true') | bool }}"

    script_path: /home/{{ ansible_user }}/greeter.sh

  tasks:
    - name: Deploy application version {{ version }} to plant {{ plant }} with GUI={{ deploy_gui }}
      ansible.builtin.shell: |
        echo "Deploying version {{ version }} to plant {{ plant }} with GUI={{ deploy_gui }}"
        echo "{{ version }}" > ~/{{ version }}
      register: deploy_result
    - debug:
        var: deploy_result.stdout
    - name: Copy greeter script to server
      copy:
        src: files/greeter.sh
        dest: "{{ script_path }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
    - name: Copy systemd service file
      copy:
        src: files/greeter.service
        dest: /etc/systemd/system/greeter.service
        owner: root
        group: root
        mode: '0644'
      become: yes
      
    - name: Reload systemd to recognize new service
      command: systemctl daemon-reload
      become: yes

    - name: Enable and start greeter service
      systemd:
        name: "{{ service_name }}"
        enabled: yes
        state: started